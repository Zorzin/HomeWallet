@model HomeWallet.Models.ReceiptViewModels.CreateReceiptViewModel
@{
    ViewData["Title"] = "Create";
}

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script src="~/js/chosen.jquery.js"></script>
<link rel="stylesheet" href="~/css/chosen.css">
<h2>Create</h2>

<form asp-action="Create">

    <div class="receiptcreate">
        <div class="receiptshop">
            <label>Date</label>
          <input type="date" asp-for="Date" class="form-control" placeholder="Date" value="@Model.Date.ToString("yyyy-MM-dd")"/>
          <span asp-validation-for="Date" class="text-danger"></span>
        </div>
        <div class="receiptdate">
            <label>Shop</label>
            <select id="selectshop" data-placeholder="Select shop" asp-for="ShopID" class ="form-control chosen-single-select" asp-items="ViewBag.ShopID"></select>
          <button type="button" id="addshopbutton" class="btn btn-success" ><span class="glyphicon glyphicon-plus"></span></button>
        </div>
        <div class="receiptproducts">

        </div>
        <div class="receiptaddproduct">
          <button type="button" id="opendialogbutton" class="btn btn-success">Add product</button>
        </div>
        <br>
        <div class="productstotal">
            <label>Total:</label>
            <label id="total">0</label>
        </div>
        <div class="receiptbuttons">
            <a asp-action="Index" asp-controller="Home" class="btn btn-danger">Cancel</a>
            <input type="submit" class="btn btn-success" value="Save"/>
        </div>
    </div>
</form>


<div id="productdialog"></div>
<div id="shopdialog"></div>
@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="@Url.Content("~/js/chosen.jquery.js")" type="text/javascript"></script>
    <script type="text/javascript">
      $(document)
          .ready(function () {
              $('.chosen-group-select').chosen();
              $('.chosen-single-select').chosen();
          });
    </script>
    <script>
      $(document).on('change', '#newproductcheckbox',function () {
        if ($(this).prop("checked")) {
          $('#newproduct').show();
        } else {
          $('#newproduct').hide();
        }
      });
    </script>

    <script>

      var productdialog,shopdialog;
        $('#addshopbutton').click(function() {
          jQuery.noConflict();
            shopdialog = $('#shopdialog').dialog({
                autoOpen: true,
                modal: true,
                open: function () {
                    $(this).load('@Url.Action("CreateShop")');
                },
                buttons: {
                    "Add": function() {
                        $.ajax({
                            url: '@Url.Action("AddShop")',
                            type: 'POST',
                            data: $("#addshopform").serialize(),
                            success: function (id) {
                              $('#selectshop').append("<option value='" + id[0] + "'>" + id[1] + "</option>");
                              $('.chosen-single-select').trigger('chosen:updated');
                              shopdialog.dialog('close');
                            }
                        });
                    }
                }
        })
        });

        $('#opendialogbutton').click(function () {
          jQuery.noConflict();
          productdialog = $("#productdialog").dialog({
                autoOpen: true,
                modal: true,
                open: function() {
                    $(this).load('@Url.Action("AddProduct")');
                },
                buttons: {
                    "Add": function() {
                        AddProduct();
                    }
                }
            });
        });

        function AddProduct() {
            $.ajax({
                url: '@Url.Action("AddProduct")',
                type: 'POST',
                data: $("#addproductform").serialize(),
                success: function (data) {
                    $(".receiptproducts").append(data);
                    Total();
                    productdialog.dialog('close');
                }
            });
        };

        function Total(){
            jQuery.noConflict();
            var totalcost = 0;
            $('#total').empty();
            $('.producttotal').each(function(){
                totalcost+=parseFloat($(this).text());
            });
            $('#total').text(totalcost);
        }

        $(document).on('click', '#removeproductbutton',
            function () {
              $(this).parent().parent().parent().remove();
              Total();
            });

    </script>
}
